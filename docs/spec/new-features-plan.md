# 重构版本需求文档（PRD）

- Version: 1.0.0
- Updated at: 2006-02-10 21:45:30
- Status: 🟢 Completed

---

## 项目优化需求 - Telegram ↔ 桌面双向同步系统

**修复范围**: Python 代码、start.sh、hooks  
**不修改**: install 逻辑

---

### 问题 1: Session Management 双向同步不对称

**现状**:
- ✅ 桌面 → Telegram 同步稳定 (关闭窗口重开也能基于旧连接继续同步)
- ❌ Telegram → 桌面同步必须每次开启新 tmux session 才能工作
- 新增了 project 选择功能,但无法灵活切换回旧 session

**任务**:
1. 检查 git 历史中 session 处理的各个版本,定位设计问题
2. 诊断 Telegram → 桌面同步失败的根本原因:
   - 设计缺陷 → 提供最优解并修复
   - tmux 限制 → 记录并忽略
3. **必须修复**: tmux 窗口无法滚动查看历史记录 (关键痛点)

---

### 问题 2: Session + Project 双概念架构重构

**设计目标**:
- Session 和 Project 两个概念独立,互不冲突
- 支持对话中途跨 Project 切换 Session,保持流畅体验
- Session 切换丝滑,Project 选择准确

**功能要求**:

**1. 双向同步 (核心)**:
   - 桌面 → Telegram ✓
   - Telegram → 桌面 ✓
   - 两个方向同时正常工作

**2. Session 持久化与恢复**:
   - 误操作退出后可重新连接到原 session
   - 保留 session 历史记录
   - 支持恢复一定时间内的旧 session
   - **原则**: 除非用户主动断开,否则不应强制 "Start New"

**3. 连接控制命令**:
   - `Start New`: 开启新 session (可恢复之前的记录和历史)
   - `Stop`: 暂停双向连接 (不断开,可恢复)
   - `Terminate`: 彻底断开两端连接,停止所有同步

**可重构内容**: 
- 整个 Session + Project 逻辑和流程
- Session 连接方式必须重构

---

### 问题 3: Log 系统持久化

**要求**:
- Log 系统独立于同步状态,始终记录
- 即使执行 `Terminate` 停止同步,Log 仍应继续工作
- **最低保证**: Terminate 前的所有双端对话记录必须完整保存

**优先级**: Session 修复后再处理此模块

---

### 问题 4: Tmux 滚动卡死问题 ⚠️ 高优先级痛点

**现象**:
- Start New 时出现绿色状态栏 (可接受)
- 屏幕滚动功能失效,无法向上查看历史 (不可接受)

**任务**:
- 诊断是 tmux 配置问题还是 tmux bug
- **必须彻底修复**,这是严重影响用户体验的痛点

---

### 问题 5: Uninstall 功能

**需求**:
- 测试现有卸载功能
- 优化卸载流程,确保完整清理:
  - Python 依赖
  - 配置文件和目录
  - Git hooks
  - Tmux sessions
  - Log 文件 (可选保留)
  - 后台进程

---

### 优先级与关键指标

| 优先级 | 任务               | 成功标准                |
| ------ | ------------------ | ----------------------- |
| **P0** | Tmux 滚动修复      | 用户可正常滚动查看历史  |
| **P0** | 双向同步稳定性     | Telegram ↔ 桌面同时工作 |
| **P1** | Session 恢复机制   | 可随时重连旧 session    |
| **P1** | Log 系统持久化     | Terminate 后仍能记录    |
| **P2** | Project 切换优化   | 跨 Project 无缝切换     |
| **P2** | Uninstall 测试优化 | 完整清理所有资源        |

---

### 最终目标

1. ✅ 稳定的 Telegram ↔ 桌面双向同步
2. ✅ 用户可手动控制连接状态 (Start/Stop/Terminate)
3. ✅ 可随时选择并重连旧 session
4. ✅ Tmux 滚动功能正常
5. ✅ 完善的卸载功能

---

**主要改进**:
- 明确区分了现状、任务和成功标准
- 突出标注了两个关键痛点 (P0)
- 清晰定义了三种连接控制命令的区别
- 添加了可量化的成功标准表格
- 结构更紧凑,减少冗余描述